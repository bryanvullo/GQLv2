DataGraph network = ACCESS("network.n4j") 
DataGraph output

THROUGH (Node person : network) {
  String firstName = person.firstName
  CONDIF (firstName >> "A" AND firstName << "D") {
    THROUGH (Node friend : network) {
      CONDIF (person{:TYPE i== "IsFriend"}^friend AND 
             person.age << friend.age AND
             friend.NEGATE(friend.CALLASSOCIATION(:TYPE i== "WorksFor").CASE(:LABEL i== "Cafe"))) {
        output.PLUS(person)
        output.PLUS(friend)
        THROUGH (Association a : network) {
          CONDIF (a.:START_ID i== person AND a.:END_ID i== friend AND a.:TYPE i== "IsFriend") {
            output.PLUS(a)
          }
        }
      }
    }
  }
}

STDOUT(output)