Graph loyalty = ACCESS("./loyalty.n4j")
Graph output = loyalty

THROUGH(DataPoint p : loyalty) {
  THROUGH(DataPoint b : p - Association ^ DataPoint) {
    Graph recommendedCustomers = p - Association ^ DataPoint
    THROUGH(DataPoint q : recommendedCustomers - Association ^ b) {
      Graph pCustomerOf = p - Association ^ b
      Graph qCustomerOf = q - Association ^ b

      pCustomerOf.reward = pCustomerOf.reward.PLUS(b.bonus)
      qCustomerOf.reward = qCustomerOf.reward.PLUS(b.bonus)
    }
  }
}

output = output - Association ^ DataPoint

STDOUT(output)