# pr5.gql
DataGraph loyalty = ACCESS("loyalty.n4j")
DataGraph output = loyalty

THROUGH (Node person : loyalty) {
  THROUGH (Node business : loyalty) {
    CONDIF (person{:TYPE i== "CustomerOf"}^business) {
      THROUGH (Node otherPerson : loyalty) {
        CONDIF (person{:TYPE i== "Recommended"}^otherPerson AND 
                otherPerson{:TYPE i== "CustomerOf"}^business) {
          Association personCustomerOf = person.CALLASSOCIATION(:TYPE i== "CustomerOf")
          Association otherPersonCustomerOf = otherPerson.CALLASSOCIATION(:TYPE i== "CustomerOf")
          
          personCustomerOf.reward = personCustomerOf.reward ++ business.bonus
          otherPersonCustomerOf.reward = otherPersonCustomerOf.reward ++ business.bonus
          
          output.PLUS(personCustomerOf)
          output.PLUS(otherPersonCustomerOf)
        }
      }
    }
  }
}

output = output.NEGATE(:TYPE i== "Recommended")

STDOUT(output)