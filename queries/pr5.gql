Graph graph = READFILE "loyalty.n4j"

FOR (Node p : graph) {
    FOR (Node b : graph) {
        IF (p-[:CustomerOf]->b) {
            FOR (Node q : graph) {
                IF (p-[:Recommended]->q && q-[:CustomerOf]->b) {
                    Integer bonus = b.bonus
                    REMOVE(p-[:Recommended]->q)
                    p-[:CustomerOf{reward: reward + bonus}]->b
                    q-[:CustomerOf{reward: reward + bonus}]->b
                }
            }
        }
    }
}

PRINT(graph)